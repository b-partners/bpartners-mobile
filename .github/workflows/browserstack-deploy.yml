name: browserstack-deploy
on:
  push:
    branches:
      - '*'
  workflow_dispatch: 
  
jobs:
  install-and-test:
      runs-on: ubuntu-latest
      steps: 
        - uses: actions/checkout@v2
        - run: npm install --force
        - run: npm test


  build-android:
      needs: install-and-test
      runs-on: ubuntu-latest
      steps: 
        - uses: actions/checkout@v2

        - run: npm install

        - name: Build Android Release
          run: npm build-android
        
        - run: yarn test 

        - name: Upload APK to BrowserStack
          uses: shreyanshp/upload-app-browserstack@v3
          with:
            app-path: android/app/build/outputs/apk/release/
            browserstack-username: ${{ secrets.BROWSERSTACK_USERNAME }}
            browserstack-accesskey: ${{ secrets.BROWSERSTACK_ACCESSKEY }}

  build-ios:
      needs: install-and-test
      runs-on: [self-hosted, macos]
      steps: 
        - uses: actions/checkout@v2

        - run: npm install

        - run: cd ios && pod install

        - name: Build app
          run: npm build-ios

        - run: yarn test 

        - name: Upload IOS application to BrowserStack
          uses: shreyanshp/upload-app-browserstack@v3
          with:
            app-path: ios/build/
            browserstack-username: ${{ secrets.BROWSERSTACK_USERNAME }}
            browserstack-accesskey: ${{ secrets.BROWSERSTACK_ACCESSKEY }}
