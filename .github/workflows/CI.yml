name: CI

on:
  push:
    branches:
      - 'dev'
      - 'preprod'
      - 'prod'

  pull_request:
    branches:
      - 'dev'
      - 'preprod'
      - 'prod'

  workflow_dispatch:

jobs:
  test-ios-app:
    runs-on: macos-latest
    steps:
      - uses: actions/checkout@v2

      - name: Install dependencies
        run: |
          npm install --force
          npm install --location=global react-native-cli

      - name: Build release app for ios
        run: npm run build:ios:release:e2e

      - run: /bin/bash -c "$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/HEAD/install.sh)"

      - name: Install applesimutils
        run: |
          brew tap wix/brew
          brew install applesimutils

      - name: Run end to end tests
        run: npm run test:ios:release:e2e

  test-android-app:
    runs-on: macos-latest
    steps:
      - uses: actions/checkout@v2

      - name: Install dependencies
        run: |
          npm install --force
          npm install --location=global react-native-cli

      - name: Build preprod app for android
        run: |
          cd android && ./gradlew assemblePreprod

      - name: Setup Java
        uses: actions/setup-java@v2
        with:
          java-version: '11'
          distribution: 'adopt'

      - name: Setup android environment
        uses: android-actions/setup-android@v2

      - name: Install Android Sdk
        run: |
          sdkmanager --install "build-tools;31.0.0" platform-tools 'platforms;android-31'
          sdkmanager --install 'system-images;android-31;google_apis;x86_64' --channel=0
          sdkmanager --install 'emulator'
          sdkmanager --install 'patcher;v4'
          sdkmanager --install 'platform-tools'

      - name: Create android virtual device
        run: |
          echo no | avdmanager create avd --force --name "Pixel_5_API_31" --abi "x86_64" --tag "google_apis" --package 'system-images;android-31;google_apis;x86_64' --device 'pixel_5'

      - run: echo "alias emu="$ANDROID_HOME/tools/emulator"" >> .profile

      - run: source .profile

      - name: Run headless android emulator
        run: emu @Pixel_5_API_31 -no-audio -no-window -no-cache

      - name: Run headless android emulator
        run: emulator -avd Pixel_5_API_31 -no-audio -no-window
      

      - name: Run end to end tests
        run: npm run test:android:debug:e2e
  style:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v2

      - name: Setup Node.js
        uses: actions/setup-node@v2
        with:
          node-version: 17.x

      - run: npm install --location=global prettier
      - run: prettier --check "app/**/*.{js,ts,tsx}" "./**/*.{json,yml,yaml}"
